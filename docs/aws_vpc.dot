digraph top {
//  dpi=100
  ranksep=1.25
  rankdir=TB
  overlap=false
  clusterrank=local

  {
    node [shape=ellipse fontsize=24 style=filled fillcolor=white]
    jeip [label="elastic IP"]
    jnginx [label="nginx proxy"]
    jmaster [label="jenkins master"]
    jswarm [label="swarm client"]
    jel61 [label="swarm client"]
    jel61 [label="swarm client"]
    jel62 [label="swarm client"]
    jel63 [label="swarm client"]
    jel71 [label="swarm client"]
    jel72 [label="swarm client"]
    jel73 [label="swarm client"]

    phpfpm [label="php-fpm\n(ganglia web)"]
    gmetad
    gmond

    gel61 [label="gmond"]
    gel62 [label="gmond"]
    gel63 [label="gmond"]
    gel71 [label="gmond"]
    gel72 [label="gmond"]
    gel73 [label="gmond"]

    ueip [label="elastic IP"]
    unginx [label="nginx proxy"]
    uchiwa
    oauth2_proxy
    sensuapi [label="sensu-api"]
    sensuserver [label="sensu-server"]
    redis
    rabbitmq
    sensuclient [label="sensu-client"]
    smaster [label="sensu-client"]
    sel61 [label="sensu-client"]
    sel62 [label="sensu-client"]
    sel63 [label="sensu-client"]
    sel71 [label="sensu-client"]
    sel72 [label="sensu-client"]
    sel73 [label="sensu-client"]

    github [label="github oauth"]
  }

  color=lightgrey
  fontsize=18
  style=bold


  subgraph cluster_0 {
    label="VPC"

    subgraph cluster_1 {
      label="master"
      jnginx
      jmaster
      jswarm
      phpfpm
      gmetad
      gmond
      smaster
    }

    subgraph cluster_2 {
      label="slave el6-1"

      jel61
      gel61
      sel61
    }
    subgraph cluster_3 {
      label="slave el6-2"
      jel62
      gel62
      sel62
    }
    subgraph cluster_4 {
      label="slave el6-3"
      jel63
      gel63
      sel63
    }

    subgraph cluster_5 {
      label="slave el7-1"
      jel71
      gel71
      sel71
    }
    subgraph cluster_6 {
      label="slave el7-2"
      jel72
      gel72
      sel72
    }
    subgraph cluster_7 {
      label="slave el7-3"
      jel73
      gel73
      sel73
    }

    subgraph cluster_8 {
      label="sensu"

      unginx
      uchiwa
      oauth2_proxy
      sensuapi
      sensuserver
      sensuclient
      rabbitmq
      redis
    }
  }

  // https
  edge [color=red]
  jeip -> jnginx
  ueip -> unginx
  github -> jmaster [dir=back style=dashed]
  github -> oauth2_proxy [dir=back style=dashed]
  github -> jeip
  github -> ueip
  {rank=same jeip ueip github}

  // http
  edge [color=orange]
  jnginx -> jmaster
  unginx -> oauth2_proxy
  oauth2_proxy -> uchiwa
  uchiwa -> sensuapi

  // jnlp
  edge [color=blue]
  jmaster -> jswarm
  jmaster -> jel61
  jmaster -> jel62
  jmaster -> jel63
  jmaster -> jel71
  jmaster -> jel72
  jmaster -> jel73

  // fastcgi
  edge [color=khaki3]
  jnginx -> phpfpm

  // filesystem
  edge [color=black]
  phpfpm -> gmetad

  // ganglia xml
  edge [color=magenta]
  gmetad -> gmond

  // gmond
  edge [color=green4]
  gmond -> gel61 [dir=back]
  gmond -> gel62 [dir=back]
  gmond -> gel63 [dir=back]
  gmond -> gel71 [dir=back]
  gmond -> gel72 [dir=back]
  gmond -> gel73 [dir=back]

  // amqp
  edge [color=brown]
  sensuserver -> rabbitmq [dir=both]
  sensuapi -> rabbitmq [dir=both]
  sensuclient -> rabbitmq [dir=both]
  rabbitmq -> smaster [dir=both]
  rabbitmq -> sel61 [dir=both]
  rabbitmq -> sel62 [dir=both]
  rabbitmq -> sel63 [dir=both]
  rabbitmq -> sel71 [dir=both]
  rabbitmq -> sel72 [dir=both]
  rabbitmq -> sel73 [dir=both]

  // redis tcp
  edge [color=purple]
  sensuserver -> redis
  sensuapi -> redis
}
